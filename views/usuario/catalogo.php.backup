<?php
$page_title = "Cat√°logo de Libros - Biblioteca CIF";
require_once __DIR__ . '/../layouts/header.php';

if (!isset($_SESSION['logueado'])) {
    header('Location: index.php?ruta=login');
    exit;
}

require_once __DIR__ . '/../../config/Database.php';
$db = new Database();
$conn = $db->getConnection();

// ‚úÖ NUEVO: Verificar si el usuario tiene pr√©stamos atrasados
$tiene_atrasados = false;
$libros_atrasados = [];
$total_atrasados = 0;

if (isset($_SESSION['usuario_id'])) {
    $stmt_atrasados = $conn->prepare("
        SELECT l.titulo, p.fecha_devolucion_esperada,
               DATEDIFF(CURDATE(), p.fecha_devolucion_esperada) as dias_retraso
        FROM prestamos p
        INNER JOIN libros l ON p.libro_id = l.id
        WHERE p.usuario_id = ? 
        AND p.estado = 'activo' 
        AND p.fecha_devolucion_esperada < CURDATE()
        ORDER BY p.fecha_devolucion_esperada ASC
    ");
    $stmt_atrasados->execute([$_SESSION['usuario_id']]);
    $libros_atrasados = $stmt_atrasados->fetchAll(PDO::FETCH_ASSOC);
    $total_atrasados = count($libros_atrasados);
    $tiene_atrasados = $total_atrasados > 0;
}

$busqueda = $_GET['buscar'] ?? '';
$query = "SELECT * FROM libros WHERE cantidad_disponible > 0";

if (!empty($busqueda)) {
    $query .= " AND (titulo LIKE :busqueda OR autor LIKE :busqueda OR isbn LIKE :busqueda)";
}

$query .= " ORDER BY titulo ASC";
$stmt = $conn->prepare($query);

if (!empty($busqueda)) {
    $busquedaParam = "%$busqueda%";
    $stmt->bindParam(':busqueda', $busquedaParam);
}

$stmt->execute();
$libros = $stmt->fetchAll(PDO::FETCH_ASSOC);

require_once __DIR__ . '/../layouts/navbar.php';
?>

<style>
body {
    padding-top: 100px;
    padding-bottom: 50px;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 30px 20px;
}

.header {
    text-align: center;
    margin-bottom: 40px;
}

.header h1 {
    font-size: 2.5rem;
    color: var(--text-primary);
    margin-bottom: 10px;
}

.header p {
    color: var(--text-secondary);
    font-size: 1.1rem;
}

/* ‚úÖ NUEVO: Banner de advertencia por atraso */
.warning-banner {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    border: 3px solid #ef4444;
    border-radius: 15px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
    animation: shake 0.5s;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-10px); }
    75% { transform: translateX(10px); }
}

.warning-banner-header {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 20px;
}

.warning-icon {
    font-size: 4rem;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.warning-content h2 {
    color: #991b1b;
    font-size: 1.8rem;
    margin: 0 0 10px 0;
    font-weight: 700;
}

.warning-content p {
    color: #dc2626;
    font-size: 1.1rem;
    margin: 0;
}

.libros-atrasados-list {
    background: rgba(255, 255, 255, 0.5);
    border-radius: 10px;
    padding: 20px;
    margin-top: 20px;
}

.libro-atrasado-item {
    padding: 12px;
    background: white;
    border-left: 4px solid #ef4444;
    margin-bottom: 10px;
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.libro-atrasado-titulo {
    font-weight: 600;
    color: #991b1b;
}

.dias-retraso {
    background: #ef4444;
    color: white;
    padding: 5px 15px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 0.9rem;
}

.btn-ir-prestamos {
    display: inline-block;
    margin-top: 15px;
    padding: 12px 25px;
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
    text-decoration: none;
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.3s;
}

.btn-ir-prestamos:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
}

.search-box {
    max-width: 600px;
    margin: 0 auto 40px;
}

.search-form {
    display: flex;
    gap: 10px;
}

.search-input {
    flex: 1;
    padding: 15px 20px;
    border-radius: 12px;
    border: 2px solid var(--border-color);
    font-size: 1rem;
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.btn-search {
    padding: 15px 30px;
    background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-search:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px var(--shadow-color);
}

.libros-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 25px;
}

.libro-card {
    background: var(--bg-secondary);
    border: 2px solid var(--border-color);
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 8px 20px var(--shadow-color);
    transition: all 0.3s;
}

.libro-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 30px var(--shadow-color);
    border-color: var(--accent-primary);
}

.libro-card.bloqueado {
    opacity: 0.6;
    pointer-events: none;
}

.libro-icon {
    font-size: 3rem;
    text-align: center;
    margin-bottom: 15px;
    color: var(--accent-primary);
}

.libro-titulo {
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: 10px;
    color: var(--text-primary);
    min-height: 60px;
}

.libro-autor {
    color: var(--text-secondary);
    margin-bottom: 15px;
}

.libro-info {
    margin: 15px 0;
    padding: 15px 0;
    border-top: 1px solid var(--border-color);
    border-bottom: 1px solid var(--border-color);
}

.info-row {
    display: flex;
    justify-content: space-between;
    margin: 8px 0;
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.badge-disponible {
    background: #d1fae5;
    color: #065f46;
    padding: 5px 12px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.85rem;
}

.btn-solicitar {
    width: 100%;
    padding: 12px;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 15px;
    transition: all 0.3s;
    font-size: 1rem;
}

.btn-solicitar:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
}

.btn-solicitar:disabled {
    background: #9ca3af;
    cursor: not-allowed;
    transform: none;
}

.btn-bloqueado {
    width: 100%;
    padding: 12px;
    background: #9ca3af;
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    margin-top: 15px;
    font-size: 0.9rem;
    cursor: not-allowed;
}

.empty-state {
    text-align: center;
    padding: 80px 20px;
    color: var(--text-secondary);
}

.empty-icon {
    font-size: 5rem;
    margin-bottom: 20px;
}

.alert {
    padding: 15px 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    font-weight: 600;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
}

.alert-success {
    background: #d1fae5;
    color: #065f46;
    border: 2px solid #10b981;
}

.alert-danger {
    background: #fee2e2;
    color: #991b1b;
    border: 2px solid #ef4444;
}

.alert-warning {
    background: #fef3c7;
    color: #92400e;
    border: 2px solid #fbbf24;
}

@media (max-width: 768px) {
    .warning-banner-header {
        flex-direction: column;
        text-align: center;
    }
    
    .libro-atrasado-item {
        flex-direction: column;
        gap: 10px;
        text-align: center;
    }
}
</style>

<div class="container">
    <div class="header">
        <h1>üìö Cat√°logo de Libros</h1>
        <p>Explora nuestra colecci√≥n disponible</p>
    </div>

    <!-- ‚úÖ NUEVO: Banner de advertencia si tiene pr√©stamos atrasados -->
    <?php if ($tiene_atrasados): ?>
        <div class="warning-banner">
            <div class="warning-banner-header">
                <div class="warning-icon">üö´</div>
                <div class="warning-content">
                    <h2>‚ö†Ô∏è Pr√©stamos Atrasados - Cuenta Bloqueada</h2>
                    <p>No puedes solicitar nuevos libros hasta que devuelvas los siguientes <?= $total_atrasados ?> libro(s) atrasado(s):</p>
                </div>
            </div>
            
            <div class="libros-atrasados-list">
                <?php foreach ($libros_atrasados as $atrasado): ?>
                    <div class="libro-atrasado-item">
                        <span class="libro-atrasado-titulo">
                            üìñ <?= htmlspecialchars($atrasado['titulo']) ?>
                        </span>
                        <span class="dias-retraso">
                            ‚è∞ <?= $atrasado['dias_retraso'] ?> d√≠a(s) de retraso
                        </span>
                    </div>
                <?php endforeach; ?>
            </div>
            
            <a href="index.php?ruta=mis_prestamos" class="btn-ir-prestamos">
                üìö Ir a Mis Pr√©stamos para Devolver
            </a>
        </div>
    <?php endif; ?>

    <!-- Mensajes del sistema -->
    <?php if (isset($_SESSION['mensaje'])): ?>
        <?php 
        // ‚úÖ CORREGIDO: Manejar mensaje como array
        $mensaje_tipo = is_array($_SESSION['mensaje']) ? $_SESSION['mensaje']['tipo'] : 'success';
        $mensaje_texto = is_array($_SESSION['mensaje']) ? $_SESSION['mensaje']['texto'] : $_SESSION['mensaje'];
        ?>
        <div class="alert alert-<?= htmlspecialchars($mensaje_tipo) ?>">
            <?= htmlspecialchars($mensaje_texto) ?>
        </div>
        <?php unset($_SESSION['mensaje']); ?>
    <?php endif; ?>

    <?php if (isset($_SESSION['error'])): ?>
        <div class="alert alert-danger">
            <?= htmlspecialchars($_SESSION['error']) ?>
        </div>
        <?php unset($_SESSION['error']); ?>
    <?php endif; ?>

    <div class="search-box">
        <form method="GET" class="search-form">
            <input type="hidden" name="ruta" value="catalogo">
            <input type="text" name="buscar" class="search-input"
                   placeholder="üîç Buscar por t√≠tulo, autor o ISBN..."
                   value="<?= htmlspecialchars($busqueda) ?>">
            <button type="submit" class="btn-search">
                Buscar
            </button>
        </form>
    </div>

    <?php if (empty($libros)): ?>
        <div class="empty-state">
            <div class="empty-icon">üìö</div>
            <h3>No se encontraron libros disponibles</h3>
            <p>Intenta con otra b√∫squeda</p>
        </div>
    <?php else: ?>
        <div class="libros-grid">
            <?php foreach ($libros as $libro): ?>
                <?php
                $titulo = $libro['titulo'] ?? 'Sin t√≠tulo';
                $autor = $libro['autor'] ?? 'Sin autor';
                $isbn = $libro['isbn'] ?? 'N/A';
                $editorial = $libro['editorial'] ?? 'N/A';
                $anio = $libro['anio_publicacion'] ?? 'N/A';
                $disponible = intval($libro['cantidad_disponible'] ?? 0);
                $total = intval($libro['cantidad_total'] ?? 0);
                $libro_id = intval($libro['id'] ?? 0);
                ?>
                <div class="libro-card <?= $tiene_atrasados ? 'bloqueado' : '' ?>">
                    <div class="libro-icon">üìñ</div>
                    <div class="libro-titulo">
                        <?= htmlspecialchars($titulo) ?>
                    </div>
                    <div class="libro-autor">
                        ‚úçÔ∏è <?= htmlspecialchars($autor) ?>
                    </div>

                    <div class="libro-info">
                        <div class="info-row">
                            <span><strong>ISBN:</strong></span>
                            <span><?= htmlspecialchars($isbn) ?></span>
                        </div>
                        <div class="info-row">
                            <span><strong>Editorial:</strong></span>
                            <span><?= htmlspecialchars($editorial) ?></span>
                        </div>
                        <div class="info-row">
                            <span><strong>A√±o:</strong></span>
                            <span><?= htmlspecialchars(strval($anio)) ?></span>
                        </div>
                        <div class="info-row">
                            <span><strong>Disponibles:</strong></span>
                            <span class="badge-disponible">
                                ‚úÖ <?= $disponible ?> / <?= $total ?>
                            </span>
                        </div>
                    </div>

                    <?php if ($tiene_atrasados): ?>
                        <!-- ‚úÖ Bot√≥n bloqueado si tiene atrasos -->
                        <button class="btn-bloqueado" disabled>
                            üö´ Pr√©stamos Bloqueados
                        </button>
                    <?php elseif ($libro_id > 0): ?>
                        <!-- ‚úÖ Bot√≥n normal si no tiene atrasos -->
                        <form method="POST" action="index.php?ruta=prestamos&accion=solicitar" style="margin: 0;">
                            <input type="hidden" name="libro_id" value="<?= $libro_id ?>">
                            <button type="submit" class="btn-solicitar" 
                                    onclick="return confirm('¬øConfirmas que deseas solicitar este libro en pr√©stamo por 15 d√≠as?')">
                                üìö Solicitar Pr√©stamo
                            </button>
                        </form>
                    <?php endif; ?>
                </div>
            <?php endforeach; ?>
        </div>
    <?php endif; ?>
</div>

<?php require_once __DIR__ . '/../layouts/footer.php'; ?>